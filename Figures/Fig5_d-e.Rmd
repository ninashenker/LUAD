---
title: "Figure 5: Association of module scores in normal tissue with different variables - Dot plot and elbow plot of c-index values across modules and TCGA cohorts"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
suppressPackageStartupMessages({
  library(survival)
  # library(survminer)
  # library(survcomp)
  library(dplyr)
  library(openxlsx)
  library(stringr)
  library(matrixStats)
  library(tidyr)
  library(readr)
  library(ggrepel)
})
```

```{r}
results_tab <- read.xlsx("/gpfs/data/tsirigoslab/home/leh06/Others/NYU_RNA/surv_stats_tcga_modules_filtered.xlsx")

results_tab$c_index_ranks <- order(results_tab$c_index)

# Reverse all c-indexes
results_tab$c_index = 1 - results_tab$c_index

results_tab$cohort <- str_replace_all(results_tab$cohort, "BRCA", "Breast")
results_tab$cohort <- str_replace_all(results_tab$cohort, "KIRC", "Kidney")
results_tab$cohort <- str_replace_all(results_tab$cohort, "HNSC", "Head and Neck")
results_tab$cohort <- str_replace_all(results_tab$cohort, "LUNG", "Lung")

results_tab$labels <- results_tab$module
results_tab$labels[results_tab$module == "20"] <- paste0("module-20/",results_tab[results_tab$module == "20","cohort"])
results_tab$labels[results_tab$module != "20"] <- ""

results_tab$module <- as.integer(results_tab$module)
results_tab
```

1. An elbow plot, as follows:
- x-axis = C-index rank, low to high as in the Excel
- y-axis = C-index value
- dot color proportional to p-value (red-to-blue palette)
- label only the 4 dots that are related to module 20; the point is to highlight that module 20 has the best ranks

```{r}
# Generate elbow plot
png(file="/gpfs/data/tsirigoslab/home/leh06/Others/NYU_RNA/elbow_tcga_c_indexes_modules_v2.png",  width = 14, height = 11, units = 'in', res = 600)
ggplot(results_tab, aes(x = c_index_ranks, 
                          y = c_index, 
                          color = pval)) + 
  geom_point(size = 6, alpha = 0.75) +
  labs(color = "P-value") +
  theme_bw(base_rect_size = 1, base_line_size = 0.3) +
  theme(text = element_text(size = 40), legend.key.size = unit(1.5, 'cm')) +
  # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_color_gradient(high = "red", low = "blue", trans = 'reverse') +
  ylab("C-index") +
  xlab("C-index ranks") +
  # ggtitle("Elbow plot of c-indexes") +
  geom_label_repel(data = subset(results_tab, module=="20"),
                   aes(label = labels, color = NULL),
                   size = 10,
                   nudge_x = 25,
                   nudge_y = 0.04,
                   segment.color = "black",
                   segment.size = 0.5) 

dev.off()
```

2. A dot plot as follows:
- rows = modules
- columns = cancer types
- dot size inversely proportional to c-index (low c-index = big size)
- dot color according to p-value (use the red-to-orange palette that you have used before for the Hallmarks)

```{r}
results_tab_filtered <- results_tab[results_tab$pval<0.15,]

# Generate dotplot
png(file="/gpfs/data/tsirigoslab/home/leh06/Others/NYU_RNA/dotplot_tcga_c_indexes_modules_v2.png",  width = 7, height = 10, units = 'in', res = 600)
ggplot(results_tab_filtered, aes(x = cohort, 
                          y = as.factor(module), 
                          color = c_index, size=pval)) + 
  geom_point() +
  scale_size_continuous(range = c(15,5), breaks = c(0.025, 0.05, 0.100)) +
  labs(color = "C-index", size = "P-value") +
  theme_bw(base_rect_size = 1, base_line_size = 0.3) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(size = 30), legend.key.size = unit(0.75, 'cm'),
        axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)) +
  scale_color_gradient(high = "red", low = "blue") +
  xlab("Cancer type") +
  # ggtitle("Dotplot of c-indexes") +
  scale_y_discrete("Module", labels = as.character(results_tab_filtered$module), breaks = results_tab_filtered$module)
dev.off()
```

